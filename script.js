let mappa = {
    "st1": {
        "stanza": "st1",
        "N": 1,
        "S": 1,
        "E": 2,
        "O": 1,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st2": {
        "stanza": "st2",
        "N": 2,
        "S": 12,
        "E": 3,
        "O": 1,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st3": {
        "stanza": "st3",
        "N": 3,
        "S": 3,
        "E": 2,
        "O": 4,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st4": {
        "stanza": "st4",
        "N": 4,
        "S": 14,
        "E": 4,
        "O": 3,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st5": {
        "stanza": "st5",
        "N": 5,
        "S": 15,
        "E": 5,
        "O": 5,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st6": {
        "stanza": "st6",
        "N": 6,
        "S": 6,
        "E": 7,
        "O": 6,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st7": {
        "stanza": "st7",
        "N": 7,
        "S": 17,
        "E": 8,
        "O": 6,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st8": {
        "stanza": "st8",
        "N": 8,
        "S": 18,
        "E": 8,
        "O": 7,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st9": {
        "stanza": "st9",
        "N": 9,
        "S": 19,
        "E": 10,
        "O": 9,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st10": {
        "stanza": "st10",
        "N": 10,
        "S": 10,
        "E": 10,
        "O": 9,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st11": {
        "stanza": "st11",
        "N": 11,
        "S": 21,
        "E": 11,
        "O": 11,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st12": {
        "stanza": "st12",
        "N": 2,
        "S": 12,
        "E": 13,
        "O": 12,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st13": {
        "stanza": "st13",
        "N": 13,
        "S": 13,
        "E": 14,
        "O": 12,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st14": {
        "stanza": "st14",
        "N": 4,
        "S": 24,
        "E": 15,
        "O": 13,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st15": {
        "stanza": "st15",
        "N": 5,
        "S": 15,
        "E": 16,
        "O": 14,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st16": {
        "stanza": "st16",
        "N": 16,
        "S": 16,
        "E": 17,
        "O": 15,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st17": {
        "stanza": "st17",
        "N": 7,
        "S": 27,
        "E": 17,
        "O": 16,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st18": {
        "stanza": "st18",
        "N": 8,
        "S": 28,
        "E": 19,
        "O": 18,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st19": {
        "stanza": "st19",
        "N": 9,
        "S": 29,
        "E": 20,
        "O": 18,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st20": {
        "stanza": "st20",
        "N": 20,
        "S": 30,
        "E": 20,
        "O": 19,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st21": {
        "stanza": "st21",
        "N": 11,
        "S": 21,
        "E": 22,
        "O": 21,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st22": {
        "stanza": "st22",
        "N": 22,
        "S": 32,
        "E": 23,
        "O": 21,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st23": {
        "stanza": "st23",
        "N": 23,
        "S": 23,
        "E": 24,
        "O": 22,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st24": {
        "stanza": "st24",
        "N": 14,
        "S": 34,
        "E": 24,
        "O": 23,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st25": {
        "stanza": "st25",
        "N": 25,
        "S": 25,
        "E": 26,
        "O": 25,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st26": {
        "stanza": "st26",
        "N": 26,
        "S": 26,
        "E": 27,
        "O": 25,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st27": {
        "stanza": "st27",
        "N": 17,
        "S": 37,
        "E": 27,
        "O": 26,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st28": {
        "stanza": "st28",
        "N": 18,
        "S": 38,
        "E": 28,
        "O": 28,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st29": {
        "stanza": "st29",
        "N": 19,
        "S": 39,
        "E": 30,
        "O": 29,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st30": {
        "stanza": "st30",
        "N": 20,
        "S": 40,
        "E": 30,
        "O": 29,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st31": {
        "stanza": "st31",
        "N": 31,
        "S": 31,
        "E": 32,
        "O": 31,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st32": {
        "stanza": "st32",
        "N": 22,
        "S": 32,
        "E": 32,
        "O": 31,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st33": {
        "stanza": "st33",
        "N": 33,
        "S": 33,
        "E": 33,
        "O": 33,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st34": {
        "stanza": "st34",
        "N": 24,
        "S": 34,
        "E": 35,
        "O": 34,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st35": {
        "stanza": "st35",
        "N": 35,
        "S": 35,
        "E": 36,
        "O": 34,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st36": {
        "stanza": "st36",
        "N": 36,
        "S": 36,
        "E": 37,
        "O": 35,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st37": {
        "stanza": "st37",
        "N": 27,
        "S": 37,
        "E": 38,
        "O": 36,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st38": {
        "stanza": "st38",
        "N": 28,
        "S": 38,
        "E": 38,
        "O": 37,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st39": {
        "stanza": "st39",
        "N": 29,
        "S": 39,
        "E": 39,
        "O": 39,
        "coin": 0,
        "coinPreso": false,
        "vittoria": false
    },
    "st40": {
        "stanza": "st40",
        "N": 30,
        "S": 40,
        "E": 40,
        "O": 40,
        "coin": 0,
        "coinPreso": false,
        "vittoria": true
    }
}

/* document.getElementById("comandi").style.position = 'relative';
document.getElementById("comandi").style.zIndex = 1;
document.getElementById("comandi").style.top = -845;
document.getElementById("comandi").style.left = "40%";
document.getElementById("comandi").style.background = "#fff";
document.getElementById("comandi").style.maxWidth = "50%"; */



let stato = {
    nCoin: 0,
    visuale: "E",
    /* chiavePresente: false, */
}

function converti(map) {
    let newMappa = {};

    for (let i in map) {
        newMappa[i] = {};
        newMappa[i].stanza = i.toString();
        newMappa[i].N = map[i][0];
        newMappa[i].S = map[i][1];
        newMappa[i].E = map[i][2];
        newMappa[i].O = map[i][3];
        newMappa[i].coin = 0;
        newMappa[i].vittoria = false;
    }
    return newMappa;
}


/* ==================== */
/* DISEGNA LA STANZA 3D */
/* ==================== */

let disegnaStanza = () => {
    let altezza=window.innerHeight;
	let larghezza=window.innerWidth;
    let tela = document.getElementById("tela");

    tela.style.width = "70%";
    tela.style.height = "50%";
    tela.style.border = "1px solid black";
    let context = tela.getContext("2d");
    //context.beginPath();
    linee(0, 0, tela.width/3, tela.height/3);
    linee(0, tela.height, tela.width/3, tela.height/3*2);
    linee(tela.width, 0, tela.width/3*2, tela.height/3);
    linee(tela.width, tela.height, tela.width/3*2, tela.height/3*2);
    context.beginPath();
    context.fillStyle = "lightgrey";
    context.fillRect(tela.width/3, tela.height/3, tela.width/3, tela.height/3)
    //context.strokeStyle = "black";
    // non si colorava di nero altrimenti
    for (let i=0; i<4; i++)
        context.rect(tela.width/3, tela.height/3, tela.width/3, tela.height/3);
    context.stroke();
    
    /* cerchioDestro();
    cerchioSinistro();
    portaCentrale(); */
}

let controlloDisegno = () => {
    let posizioneCorrente = posStanza(40, false);

}

let cerchioSinistro = () => {
    let tela = document.getElementById("tela");
    let context = tela.getContext("2d");
    // cerchio laterale sinistro
    context.fillStyle = "red";
    context.beginPath();
    context.arc(tela.width/6, tela.height/2, tela.height/8, 0, 2*Math.PI);
    context.fill();
}

let cerchioDestro = () => {
    let tela = document.getElementById("tela");
    let context = tela.getContext("2d");
    // cerchio laterale destro
    context.fillStyle = "red";
    context.beginPath();
    context.arc(tela.width/6*5, tela.height/2, tela.height/8, 0, 2*Math.PI);
    context.fill();
}

let portaCentrale = () => {
    let tela = document.getElementById("tela");
    let context = tela.getContext("2d");
    // porta centrale
    context.beginPath();
    context.fillStyle = "black";
    context.fillRect(tela.width/9*4, tela.height/9*4, tela.width/9, tela.height/9*2);
    context.rect(tela.width/9*4, tela.height/9*4, tela.width/9, tela.height/9*2);
    context.stroke();
}

let linee = (Px,Py,Fx,Fy) => {
    let elemento = document.getElementById("tela");
    let contesto = elemento.getContext("2d");				
    contesto.moveTo(Px,Py);
    contesto.lineTo(Fx,Fy);
    contesto.stroke();
}

let cancellaPortaCentrale = () => {
    let tela = document.getElementById("tela");
    let context = tela.getContext("2d");
    context.save();                                       // Save the current context state
    context.setTransform(1, 0, 0, 1, 0, 0);               // Reset the transformation matrix
    context.clearRect(0, 0, tela.width, tela.height); // Clear the canvas
    context.restore();
}

let disegnaPorta = () => {
    let state = true;
    let posizione = posStanza(40, false, true);
    cancellaPortaCentrale();
    cancellaPortaCentrale();
    disegnaStanza();
    if (!parseInt(posizione)) state = false;
    if (state) {
        if (stato.visuale == "E") {
            if (mappa[`st${posizione}`].E != posizione) portaCentrale();
            if (mappa[`st${posizione}`].N != posizione) cerchioSinistro();
            if (mappa[`st${posizione}`].S != posizione) cerchioDestro();
        }
        else if (stato.visuale == "N") {
            if (mappa[`st${posizione}`].N != posizione) portaCentrale();
            if (mappa[`st${posizione}`].O != posizione) cerchioSinistro();
            if (mappa[`st${posizione}`].E != posizione) cerchioDestro();
        }
        else if (stato.visuale == "S") {
            if (mappa[`st${posizione}`].S != posizione) portaCentrale();
            if (mappa[`st${posizione}`].E != posizione) cerchioSinistro();
            if (mappa[`st${posizione}`].O != posizione) cerchioDestro();
        }
        else if (stato.visuale == "O") {
            if (mappa[`st${posizione}`].O != posizione) portaCentrale();
            if (mappa[`st${posizione}`].S != posizione) cerchioSinistro();
            if (mappa[`st${posizione}`].N != posizione) cerchioDestro();
        }
    }
}

/* ============================== */
/* DISEGNA LE PORTE SULLO SCHERMO */
/* ============================== */

let disegnaPorte = (nStanze) => {
  for (let i=1; i<=nStanze; i++) {
    if (mappa[`st${i}`].N != i) 
      document.getElementById(`st${i}`).style.borderTop = "dotted black";
    if (mappa[`st${i}`].E != i) 
      document.getElementById(`st${i}`).style.borderRight = "dotted black";
    if (mappa[`st${i}`].S != i) 
      document.getElementById(`st${i}`).style.borderBottom = "dotted black";
    if (mappa[`st${i}`].O != i) 
      document.getElementById(`st${i}`).style.borderLeft = "dotted black";
    if (mappa[`st${i}`].vittoria) document.getElementById(`st${i}`).style.backgroundColor = "yellow"
  }
}

document.body.onload = () => {
    disegnaPorte(40);
    assegnaCoin(0,5);

    disegnaStanza();
    
    setInterval(() => {
        let altezza=window.innerHeight;
        let larghezza=window.innerWidth;
        let elem = document.getElementById("comandi");
        elem.style.background = "#fff";
        elem.style.left = larghezza-elem.offsetWidth-20;
    }, 100);

}


/* =============== */
/* AVVIO DEL GIOCO */
/* =============== */

function start(nStanze=18) {
    let state = false;
    for (let i=0; i<nStanze; i++) {
        if (document.getElementById(`st${i+1}`).innerHTML == "🦕") {
            state = true;
            break;
        }
    }
    if (!state)
        document.getElementById("st1").innerHTML = "🦕";
    else alert("Il gioco è già iniziato!");
    
    onStart();
    /* generaChiave(); */
}

/* ======================== */
/* GESTIONE DEL PERSONAGGIO */
/* ======================== */

function creazionePersonaggio(idCella="st1") {
    document.getElementById(idCella).innerHTML = "🦕";
}

function rimozionePersonaggio(idCella="st1") {
    document.getElementById(idCella).innerHTML = "";
}

/* =========== */
/* SPOSTAMENTO */
/* =========== */

document.getElementById("avanti").onclick = (nStanze=40) => {
    let posizioneCorrente, state = true;
    posizioneCorrente = posStanza(40, false, true);
    if (!posizioneCorrente) state = false;
    //console.log(posizioneCorrente)

    if (!state) alert("Non hai ancora iniziato il gioco!");
    else {
        if (posizioneCorrente != mappa[`st${posizioneCorrente}`][stato.visuale]) {
            if (document.getElementById(`st${posizioneCorrente}`).innerHTML == "🦕") {
                if (stato.visuale == "E") {
                    rimozionePersonaggio(`st${posizioneCorrente}`);
                    creazionePersonaggio(`st${posizioneCorrente+1}`);
                }
                else if (stato.visuale == "O") {
                    rimozionePersonaggio(mappa[`st${posizioneCorrente}`].stanza);
                    creazionePersonaggio(`st${posizioneCorrente-1}`);
                }
                else if (stato.visuale == "N") {
                    rimozionePersonaggio(mappa[`st${posizioneCorrente}`].stanza);
                    creazionePersonaggio(`st${posizioneCorrente-10}`);
                }
                else if (stato.visuale == "S") {
                    rimozionePersonaggio(mappa[`st${posizioneCorrente}`].stanza);
                    creazionePersonaggio(`st${posizioneCorrente+10}`);
                }
            }
            
            onStart();
        }
    }
}

function spostaADestra() {
    let state = true;
    if (!posStanza(40, false, true));
    if (state) {
        stato.visuale = "E";
        aggiornaVisuale();
        for (let i=0; i<2; i++) disegnaPorta();
    }
}

function spostaASinistra() {
    let state = true;
    if (!posStanza(40, false, true));
    if (state) {
        stato.visuale = "O";
        aggiornaVisuale();
        for (let i=0; i<2; i++) disegnaPorta();
    }
}

function spostaSopra() {
    let state = true;
    if (!posStanza(40, false, true));
    if (state) {
        stato.visuale = "N";
        aggiornaVisuale();
        for (let i=0; i<2; i++) disegnaPorta();
    }
}

function spostaGiu() {
    let state = true;
    if (!posStanza(40, false, true));
    if (state) {
        stato.visuale = "S";
        aggiornaVisuale();
        for (let i=0; i<2; i++) disegnaPorta();
    }
}

let aggiornaVisuale = () => {
    document.getElementById("visuale").innerHTML = `Stai guardando verso: ${stato.visuale}`;
}

/* ===== */
/* RESET */
/* ===== */

function restart(nStanze=18) {
    let state = true;
    let posizione = posStanza(40, false, true);
    if (!parseInt(posizione)) state = false;
    if (state) {
        rimozionePersonaggio(`st${posizione}`);
        state = true;
        stato.visuale = "E";
        /* generaChiave(); */
        azzeraCoin();
        onStart();
        for (let i=0; i<2; i++) disegnaPorta();

        start(nStanze);
        document.getElementById("menu").innerHTML = '<button onclick="start()" id="avvio">Inizia il gioco</button><button onclick="restart(40)" id="ricomincia">Restart</button><p>Gioco restartato!</p>';

        setTimeout(function () {
            document.getElementById("menu").innerHTML = '<button onclick="start()" id="avvio">Inizia il gioco</button><button onclick="restart(40)" id="ricomincia">Restart</button>';
        }, 2000);
    }
    else alert("Il gioco non è ancora iniziato!");
}

/* ================ */
/* POSIZIONE STANZA */
/* ================ */

function posStanza(nStanze, mostra=true, onlyNumber=false) {
    let pos = ``;
    for (let i=0; i<nStanze; i++) {
        if (document.getElementById(`st${i+1}`).innerHTML == "🦕" && mostra) {
            pos = `stanza ${i+1}`;
            break;
        }
        else if (document.getElementById(`st${i+1}`).innerHTML == "🦕" && onlyNumber) {
            pos = i+1;
            break
        }
        else if (document.getElementById(`st${i+1}`).innerHTML == "🦕") {
            pos = `st${i+1}`;
            break;
        }
        pos = "gioco non iniziato";
    }
    return pos;
}

function onStart() {
    aggiornaVisuale();
    for (let i=0; i<2; i++) disegnaPorta();
    onStartCoin();
    document.getElementById("posCorrente").innerHTML = `Posizione: ${posStanza(40)}`;
    controlloVittoria();
}

/* =============== */
/* GESTIONE MONETE */
/* =============== */

let coinPreso = () => {
    let nCoin = stato.nCoin;
    let stanzaCorrente = posStanza(40, false);

    if (!mappa[stanzaCorrente]?.coinPreso) {
        nCoin += mappa[stanzaCorrente]?.coin;
        mappa[stanzaCorrente].coinPreso = true;
    }
    
    return nCoin;
}

let onStartCoin = () => {
    let currentTotalCoin = stato.nCoin;
    let stanzaCorrente = posStanza(40, false);
    
    if (!mappa[stanzaCorrente]?.coinPreso && stanzaCorrente == 'st1') {
        currentTotalCoin = 0;
        mappa[stanzaCorrente].coinPreso = true;
    }
    else if (!mappa[stanzaCorrente]?.coinPreso && mappa[stanzaCorrente]) {
        currentTotalCoin = coinPreso();
        
        if (mappa[stanzaCorrente].coin > 0) {
            document.getElementById("coinPresi").innerHTML = `Hai preso ${mappa[stanzaCorrente].coin} coin!`;
            setTimeout(function () {
                document.getElementById("coinPresi").innerHTML = "";
            }, 1000);
        }
    }
    //console.log(currentTotalCoin)
    //console.log(typeof(currentTotalCoin))
    stato.nCoin = currentTotalCoin;
    document.getElementById("coin").innerHTML = `Monete raccolte: ${currentTotalCoin}`;
}

let azzeraCoin = () => {
    stato.nCoin = 0;
    for (let i in mappa) {
        mappa[i].coinPreso = false;
    }
    document.getElementById("coin").innerHTML = `Monete raccolte: ${stato.nCoin}`;
}

let random = (min, max) => {
    min = Math.ceil(min);
    max = Math.floor(max);
    return Math.floor(Math.random() * (max - min + 1) + min);
  }

let assegnaCoin = (min, max) => {
    for (let i in mappa) {
        if (i != "st1") {
            mappa[i].coin = random(min,max);
            /* console.log(mappa[i].stanza);
            console.log(mappa[i].coin); */
        }
    }
}

/* ================= */
/* GESTIONE VITTORIA */
/* ================= */

let controlloVittoria = () => {
    if (mappa[posStanza(40, false)]?.vittoria) {
        //console.log('Hai vinto!\nIl gioco ripartirà tra 3 secondi!');
        document.getElementById("vittoria").innerHTML = 'Hai vinto! Il gioco ripartirà tra 3 secondi!';
        setTimeout(function (){
            document.getElementById("vittoria").innerHTML = "";
            restart(40);
        }, 3000)
    }
}

/* =============== */
/* GESTIONE CHIAVE */
/* =============== */

/* let generaChiave = (nStanze=40) => {
    let posizioneChiave = random(5,40);
    stato.posizioneChiave = `st${posizioneChiave}`;
    if (!stato.chiavePresente) {
        stato.stanzaAccessibile = false;
        mappa[`st${posizioneChiave}`].chiavePresente = true;
        mappa[`st${posizioneChiave}`].chiaveRaccolta = false;
        document.getElementById(`st${posizioneChiave}`).innerHTML = "🔑";
    } else {
        stato.chiavePresente = false;
        stato.stanzaAccessibile = false;
        mappa[`st${posizioneChiave}`].chiaveRaccolta = false;
        mappa[`st${posizioneChiave}`].chiavePresente = false;
        generaChiave();
    }
}

let controlloChiavePresa = (nStanze=40) => {
    let posizione = posStanza(nStanze, false);
    if (posizione == stato.posizioneChiave && !mappa[`st${posizioneChiave}`].chiaveRaccolta) {
        mappa[`st${stato.posizioneChiave}`].chiaveRaccolta = true;
        stato.stanzaAccessibile = true;
    }
} */